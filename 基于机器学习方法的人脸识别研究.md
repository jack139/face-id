## 基于机器学习方法的人脸识别研究



### 1.简介

​		人脸识别包括：1:1人脸验证，1:N人脸查找。人脸识别过程包括：人脸图像采集、人脸定位、人脸对齐、人脸验证/查找。人脸识别系统的输入是含有未确定身份的人脸图像，以及人脸数据库中若干已知身份的人脸图像或响应特征编码，输出则是一系列相似度得分，表明待识别的人脸的身份。
目前人脸识别算法可以分为：

- 基于人脸特征点的识别算法
- 基于整幅人脸图像的识别算法
- 基于模板的识别算法
- 利用神经网络进行识别的算法
- 利用支持向量机进行识别的算法

​		本次研究主要为使用深度学习进行识别的算法模型。深度学习是神经网络算法的一个分支。核心算法过程是，(1)通过网络模型提取人脸特征数据，(2)根据特征数据，使用深度学习或机器学习算法对人脸进行分类查找。

### 2.开源模型

1. face-recognition https://github.com/ageitgey/face_recognition
2. vggface https://github.com/rcmalli/keras-vggface
3. face.evoLVe https://github.com/ZhaoJ9014/face.evoLVe.PyTorch
4. facenet https://github.com/davidsandberg/facenet
5. deepface https://github.com/ildoonet/deepface

​		以上模型均带有预训练权重数据，可直接进行识别测试，评估准确度。

​		为提高准确度，采用并行算法方式，即对同一人脸使用两种算法同时进行识别，然后合并识别结果，测试的并行算法包括：
6. 双模型并行识别（senet50 + IR152）
7. 双模型并行识别（senet50 + face-recognition）
8. 双模型并行识别（senet50 + deepface）

​		为提高准确度，亦采用合并特征值方式，即将两个模型产生的特征值进行合并，生成新的特征值，然后用新的特征值构建特征库进行识别，测试的合并特征值包括：

9. 合并特征值（senet50 + IR152）



### 3.数据来源

​		因为上述模型训练的数据集主要是西方人脸，所以测试数据集选取两类人脸：东方人和西方人，分别进行测试和对比。

- 西方人脸（CASIA-WebFace） https://github.com/ZhaoJ9014/face.evoLVe.PyTorch#Data-Zoo
- 东方人脸1（RMFD） https://github.com/X-zhangyang/Real-World-Masked-Face-Dataset
- 东方人脸2（Asian-Celeb）https://github.com/deepinsight/insightface/wiki/Dataset-Zoo



### 4.测试方法

1. 从三个人脸库中各选50个人，每人取20张可定位到人脸的照片，10张用于训练，10张用于识别测试；（东方人1A，西方人A，东方人2A）
2. 扩大数据集（均扩大到400人），其他条件不变；（东方人1B，西方人B，东方人2B）



### 5.测试结果

1. 使用K临近值方法进行分类查找（使用10张人脸进行训练）

| 算法模型         | 东方人1A | 东方人1B | 西方人A | 西方人B |
| -------------------------- | -------------------------------------- | -------------------------------------- | ----------------- | ----------------- |
| face-recognition           | 0.790                                  |                                        | 0.980             |                   |
| vggface-vgg16              | 0.690                                  |                                        | 0.875             |                   |
| vggface-senet50            | 0.933                                  |                                        | 0.975             |                   |
| vggface-resnet50           | 0.882                                  |                                        | 0.973             |                   |
| face.evoLVe-IR50-asia      | 0.755                                  |                                        | 0.890             |                   |
| face.evoLVe-IR50-ms1m      | 0.802                                  |                                        | 0.941             |                   |
| face.evoLVe-IR152          | 0.906                                  |                                        | 0.971             |                   |
| facenet                    | 0.737                                  |                                        | 0.925             |                   |
| deepface                   | 0.855                                  |                                        | 0.975             |                   |
| senet50 + IR152            | 0.955                                  | 0.867                                  | 0.984             | 0.968             |
| senet50 + face-recognition | 0.941                                  | 0.809                                  | 0.986             | 0.961             |
| senet50 + deep             | 0.943                                  | 0.810                                  | 0.984             | 0.960             |
| senet50 + IR152特征合并    | 0.931                                  |                                        | 0.963             |                   |

2. 使用K临近值方法进行分类查找（使用3张人脸进行训练）

| 算法模型                   | 东方人1A | 东方人1B | 西方人A | 西方人B | 东方人2A | 东方人2B |
| -------------------------- | -------- | -------------------------------------- | ----------------- | ----------------- | ------------------ | ------------------ |
| senet50 + IR152            | 0.888    | 0.692                                  | 0.965             | 0.942             | 0.947              | 0.862              |
| senet50 + face-recognition | 0.806    | 0.618                                  | 0.976             | 0.916             | 0.929              | 0.754              |

3. 使用深度学习方法进行分类查找（使用3张人脸进行训练）

| 算法模型      | 东方人1A | 东方人1B | 西方人A | 西方人B | 东方人2A | 东方人2B |
| ----------------------- | -------------------------------------- | -------------------------------------- | ----------------- | ----------------- | ------------------ | ------------------ |
| senet50                 | 0.9232                                 | 0.7146                                 | 0.9604            | 0.9255            | 0.9832             | 0.9209             |
| IR152                   | 0.8627                                 | 0.6730                                 | 0.9508            | 0.8985            | 0.9524             | 0.9095             |
| senet50 + IR152特征合并 | 0.9328                                 | 0.7980                                 | 0.9664            | 0.9419            | 0.9915             | 0.9605             |

4. 数据增强训练模型（使用“东方人1B”训练，使用K临近分类查找，10张人脸注册）

| 算法模型                   | 东方人1Asenet50 | 东方人2Asenet50 | 东方人1Asenet50+IR152 | 东方人2Asenet50+IR152 |
| ------------------------------------ | ------------------------------------------------------- | --------------------------------------------- | ------------------------------------------------------------ | --------------------------------------------------- |
| 1次训练，epoch=100                   | 0.939                                                   | 0.963                                         | 0.955                                                        | 0.978                                               |
| 2次训练，epoch=100*2                 | 0.953                                                   | 0.986                                         | 0.963                                                        | 0.984                                               |
| 2次训练，epoch=100*2（人脸角度修正） | 0.953                                                   | 0.976                                         | 0.967                                                        | 0.976                                               |



### 6.结果讨论

- face-recognition模型的识别准确率，对西方人比东方人要高；

- vgg16模型识别准确率较低，尤其对东方人；

- senet50和resnet50识别过程中，东方人脸大概率出现多个匹配结果情形，对西方人脸基本未出现，说明模型对东方人特征提取差异不够显著；

- 从目前结果观察，senet50模型和IR152模型对东方人脸识别率比较高，但要处理好多结果返回和非最佳结果返回；

- 算法并行识别可以提升准确率，比较显著；特征值合并也可提高准确率，但不显著；

- 数据集扩大后，准确率下降，主要原因是多结果增加，影响最终准确率，东方人准确率下降更显著，再次说明模型对东方人特征提取差异不够显著；

- 识别阈值threshold需要优化，threshold优化依据对训练集f1和acc的计算；优化后可以提高识别准确率；深度学习方法不需要提供threshold值；

- 算法并行时，两个算法结果合并的算法也会影响最终准确率；

- senet50对人脸是否对齐不敏感（人脸旋转30度扔可识别），IR152对人脸是否对齐敏感（旋转15度时即识别错误）；

- 在使用3张人脸训练特征库时，深度学习方法的准确率明显由于K临近算法；

- 图片采集质量（光照、清晰度、表情、脸部装饰、拍摄角度等）对识别结果影响较大，具体可以对比“东方人1”和“东方人2”的结果，前者采集质量较差；

- 数据增强训练可以提高准确率，对特定数据集增强训练可以加强特征提取；

- 特征合并同时使用深度学习方法分类，准确率提升明显；

  

### 7.内部转化进展

https://gitlab.ylzpay.com/guantao/face-id



#### (1) 算法后台功能

- 使用两种人脸识别模型（senet50, IR152）；
- 1:1验证使用单算法（senet50）；
- 1:N识别使用双算法并行计算特征，使用合并后的特征进行识别；
- 注册人脸数据进行自动角度修正，保存两个人脸特征：原始的、角度修正后的；
- 人脸识别时，陌生人脸会进行角度修正；
- 提供结果反馈机制，结果反馈正确的陌生人脸将加入注册库做数据增强；
- 1:N识别分两级，主库和临时库，主库保存所有特征，临时库保存最近（例如1天）新注册的人脸特征（因为注册训练耗时比较多，主库不便做实时训练，临时库可以实时训练）；
- 提供双因素识别，目前支持手机号后4位；
- 人脸特征库分组进行管理，按组训练；
- 接口与后台功能通过消息中间件解耦，同步请求、异步处理；
- 算法模型权重可进行数据增强训练；
- 特征库保存注册用户的人脸截图，便于进行再训练；

#### (2) 接口功能

> 具体见api文档

- 人脸定位
- 人脸对比
- 人脸搜索
- 识别结果反馈
- 特征库管理

#### (3) 识别率测试结果

> 基于前述三个人脸测试集，每个数据集各注册有400人，使用深度学习方法进行分类查找

1. 使用10张人脸进行训练

| 算法模型      | 西方人 | 东方人1 | 东方人2 |
| ----------------------- | -------------------------- | --------------------------- | ----------------- |
| senet50                 | 0.952                      | 0.842                       | 0.959             |
| IR152                   | 0.943                      | 0.814                       | 0.965             |
| senet50 + IR152特征合并 | 0.968                      | 0.890                       | 0.986             |

2. 使用3张人脸进行训练

| 算法模型      | 西方人 | 东方人1 | 东方人2 |
| ----------------------- | -------------------------- | --------------------------- | ----------------- |
| senet50                 | 0.914                      | 0.732                       | 0.898             |
| IR152                   | 0.928                      | 0.700                       | 0.936             |
| senet50 + IR152特征合并 | 0.953                      | 0.821                       | 0.957             |

3. 使用3张人脸进行训练，3个数据集合并为一个大库（1200人）

| 算法模型      | 西方人 | 东方人1 | 东方人2 |
| ----------------------- | -------------------------- | --------------------------- | ----------------- |
| senet50                 | 0.897                      | 0.709                       | 0.859             |
| IR152                   | 0.914                      | 0.684                       | 0.911             |
| senet50 + IR152特征合并 | 0.946                      | 0.801                       | 0.941             |



### 8.存在的问题

#### (1) 准确率问题

​		从上述测试集结果分析，准确率与许多因素相关：注册照片质量、采集照片质量、照片清晰度、光照、表情、遮挡物、人种、特征库人脸数量等都有比较大影响。在学术上，特定数据集可以做到95%以上，但对于日常应用时的准确率很难评估，影响因素太多，尤其受采集质量和人脸数量影响最明显，工程应用上，准确率能达到80%算比较好的应用了。所以在身份人种敏感的应用上，建议提高识别阈值或增加双因素认证。

#### (2) 接口速度问题

​		目前为提高准确率，使用双算法并行的方式提高识别准确率，因此每个陌生人脸需要分别计算两个算法的特征值，虽然是多线程并发执行，但受算法模型本身计算速度和测试硬件限制（测试环境：1.6GHz 4核i5CPU、8G内存、无GPU），1:1和1:N的接口处理平均在1秒到1.8秒。如果使用有GPU的硬件，会有一点速度提升，待进一步测试。

#### (3) 模型训练问题

​		目前使用的算法模型均来自开源模型，并找到已训练过的权重数据。但是开源权重数据是大多根据西方人脸训练，从目前测试情况看，随着人脸数量增加，东方人脸的召回率会低于西方人。目前已基本掌握增强训练的方法，但前提是需要有合适的训练数据集和训练的硬件GPU环境。